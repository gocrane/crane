<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.102.3"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Provide a policy-based abnormal detection mechanism in crane-agent | Crane</title><meta name=description content="Summary
Crane-agent is responsible for detecting abnormality on nodes and interference between running pods.
Currently, such detection mechanism is …"><meta property="og:title" content="Provide a policy-based abnormal detection mechanism in crane-agent"><meta property="og:description" content="Summary Crane-agent is responsible for detecting abnormality on nodes and interference between running pods.
Currently, such detection mechanism is fixed and quite simple. Crane-agent compares the values of some pre-defined metrics, such as node&rsquo;s cpu_total_usage and cpu_total_utilization, with some thresholds periodically. If the metric value is higher the threshold for some times, say the cpu_total_utilization on a node is found higher than 80% in 3 consecutive detections, crane-agent thinks the node entering into an abnormal status, and will perform some further actions, such as suppressing or evicting pods with low priorities."><meta property="og:type" content="article"><meta property="og:url" content="/docs/proposals/20220402-policy-based-abnomal-detection/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-03-15T04:27:07-05:00"><meta property="og:site_name" content="Crane"><meta itemprop=name content="Provide a policy-based abnormal detection mechanism in crane-agent"><meta itemprop=description content="Summary Crane-agent is responsible for detecting abnormality on nodes and interference between running pods.
Currently, such detection mechanism is fixed and quite simple. Crane-agent compares the values of some pre-defined metrics, such as node&rsquo;s cpu_total_usage and cpu_total_utilization, with some thresholds periodically. If the metric value is higher the threshold for some times, say the cpu_total_utilization on a node is found higher than 80% in 3 consecutive detections, crane-agent thinks the node entering into an abnormal status, and will perform some further actions, such as suppressing or evicting pods with low priorities."><meta itemprop=dateModified content="2024-03-15T04:27:07-05:00"><meta itemprop=wordCount content="1019"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Provide a policy-based abnormal detection mechanism in crane-agent"><meta name=twitter:description content="Summary Crane-agent is responsible for detecting abnormality on nodes and interference between running pods.
Currently, such detection mechanism is fixed and quite simple. Crane-agent compares the values of some pre-defined metrics, such as node&rsquo;s cpu_total_usage and cpu_total_utilization, with some thresholds periodically. If the metric value is higher the threshold for some times, say the cpu_total_utilization on a node is found higher than 80% in 3 consecutive detections, crane-agent thinks the node entering into an abnormal status, and will perform some further actions, such as suppressing or evicting pods with low priorities."><link rel=preload href=/scss/main.min.730362c672539a20af5e07f8cb554bed1d08f06cf874786f2cba9f08a6a884cb.css as=style><link href=/scss/main.min.730362c672539a20af5e07f8cb554bed1d08f06cf874786f2cba9f08a6a884cb.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="图层_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="306" height="186" viewBox="144.139 425.446 306 186" enable-background="new 144.139 425.446 306 186"><path fill="#58bda6" d="M267.919 572.702c-.372 5.728-4.972 10.091-10.27 9.743l-40.779-2.65c-5.3-.347-9.293-5.269-8.923-10.991l2.974-45.702c.373-5.728 4.973-10.088 10.271-9.743l40.78 2.652c5.299.345 9.293 5.267 8.921 10.99L267.919 572.702z"/><path fill="#ee7300" d="M355.802 528.969c-28.058-24.713-63.021-62.657-91.196-87.232-1.938-1.69-5.604-3.409-7.457-2.647-1.938.795-3.404 4.46-3.778 7.058-1.761 12.192-2.91 28.237-4.656 40.433-.437 3.041-1.971 6.067-3.571 8.762-2.041 3.435-.873 12.792 2.958 15.723 3.085 2.357 4.303 5.096 1.854 7.834-1.351 1.512-4.525 1.391-6.992 2.032 2.374 2.482 5.765 2.633 9.24-.084 3.808-2.979 2.631-7.084-4.054-14.46 4.628-3.659 5.886-7.839 2.424-13.33-1.104-1.75-.191-4.886.068-7.356 1.027-9.761 2.094-23.278 3.315-33.019.292-2.324 1.237-4.564 2.349-8.479 26.078 34.224 56.794 78.868 82.623 112.767.93-6.764-.387-17.9-.708-23.131-.193-3.154-5.785-8.536-7.861-11.352-3.039-4.109-6.746-7.742-9.644-11.94-.76-1.101-.824-2.206.128-3.594 1.252-1.816 2.925.178 3.865 1.018 9.287 8.277 25.465 24.596 31.02 35.665.248.495-1.506-11.808-.865-10.746"/><path d="M185.44 554.611v-4.04c0-2.692-.57-4.727-1.712-6.104-1.145-1.375-2.634-2.062-4.475-2.062-3.021-.056-5.026.505-6.021 1.686-.994 1.179-1.49 2.806-1.49 4.881l-.11 31.229c0 1.796.515 3.188 1.548 4.166 1.028.982 2.834 1.476 5.412 1.476 1.618.0 2.908-.295 3.866-.883.957-.593 1.692-1.334 2.21-2.231.515-.896.828-1.88.938-2.946.11-1.064.166-2.076.166-3.028v-5.726h19.442v7.744c0 2.693-.534 5.176-1.603 7.449-1.067 2.271-2.727 4.224-4.972 5.85-2.247 1.629-5.156 2.894-8.729 3.788-3.573.897-7.826 1.347-12.761 1.347-4.493.0-8.305-.447-11.435-1.347-3.132-.896-5.688-2.201-7.679-3.914-1.988-1.71-3.442-3.813-4.363-6.312-.922-2.497-1.382-5.349-1.382-8.545V551.16c0-6.899 2.117-11.979 6.354-15.233 4.232-3.254 10.808-4.883 19.72-4.883 4.124.0 7.823.353 11.104 1.054 3.275.702 6.058 1.782 8.341 3.239 2.282 1.461 4.033 3.354 5.248 5.684s1.821 5.092 1.821 8.29v5.304H185.44V554.611z"/><path fill="#fff" d="M231.8 574.649l-16.795-1.156 3.754-54.526 24.521 1.688c6.934.479 12.024 1.985 15.27 4.521 3.243 2.536 4.682 6.521 4.308 11.945-.2 2.909-.979 5.362-2.329 7.364-1.354 2.001-3.818 3.488-7.4 4.457l-.009.146c2.324.553 4.212 1.483 5.653 2.801 1.443 1.316 2.162 2.924 2.161 4.824.049 1.125.066 2.486.052 4.094-.013 1.604-.028 3.235-.047 4.892-.019 1.655-.018 3.236.007 4.749.023 1.514.135 2.712.329 3.603.389.854.887 1.521 1.49 2.002l-.051.729-18.317-1.261c-.219-.552-.392-1.086-.515-1.608-.125-.518-.199-1.046-.228-1.586.039-2.43.165-4.724.379-6.877.211-2.148.247-4.084.11-5.799-.139-1.712-.569-3.105-1.294-4.18-.726-1.074-2.071-1.726-4.036-1.958l-5.533-.381L231.8 574.649zM233.957 543.314l5.726.396c1.208.081 2.222-.041 3.045-.375.821-.334 1.479-.801 1.966-1.399s.842-1.305 1.058-2.118c.216-.812.354-1.631.409-2.455.108-1.6-.026-2.875-.409-3.827-.38-.949-1.034-1.679-1.958-2.18-.923-.501-2.132-.842-3.62-1.017-1.49-.177-3.255-.311-5.294-.401L233.957 543.314z"/><path d="M265.164 595.689l18.116-63.132h23.423l18.006 63.132h-19.663l-2.762-12.291h-15.246l-2.318 12.291H265.164zm29.828-51.684h-.222l-5.634 28.282h11.269L294.992 544.005z"/><path d="M352.709 556.745l-.223.168 1.77 35.188h-18.448v-63.132h19.995l15.024 35.269h.331l-1.88-35.269h18.45V592.1h-19.887l-15.132-35.355z"/><path d="M397.406 595.689v-63.132h44.521v12.625H416.85V556.8h24.305v12.627H416.85v13.636h26.403v12.627L397.406 595.689z"/><circle fill="#fff" cx="344.901" cy="536.967" r="3.136"/></svg></span><span class=font-weight-bold>Crane</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><i class='fas fa-book pr-2'></i><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><i class='fas fa-rss pr-2'></i><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><i class='fab fa-youtube pr-2'></i><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/gocrane/crane target=_blank><i class='fab fa-github pr-2'></i><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=http://dashboard.gocrane.io/ target=_blank><i class='fa-regular fa-flag'></i><span>Live Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Crane Blog</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Releases</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://gocrane.io>main</a></div></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/docs/proposals/20220402-policy-based-abnomal-detection/>Chinese</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/docs/proposals/20220402-policy-based-abnomal-detection/>Chinese</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsgetting-started-li><input type=checkbox id=m-docsgetting-started-check>
<label for=m-docsgetting-started-check><a href=/docs/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>Getting Started</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-startedintroduction-li><input type=checkbox id=m-docsgetting-startedintroduction-check>
<label for=m-docsgetting-startedintroduction-check><a href=/docs/getting-started/introduction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedintroduction><span>Introduction</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsgetting-startedinstallation-li><input type=checkbox id=m-docsgetting-startedinstallation-check>
<label for=m-docsgetting-startedinstallation-check><a href=/docs/getting-started/installation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-startedinstallation><span>Installation</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-startedinstallationquick-start-li><input type=checkbox id=m-docsgetting-startedinstallationquick-start-check>
<label for=m-docsgetting-startedinstallationquick-start-check><a href=/docs/getting-started/installation/quick-start/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedinstallationquick-start><span>Quick Start</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-startedinstallationinstallation-li><input type=checkbox id=m-docsgetting-startedinstallationinstallation-check>
<label for=m-docsgetting-startedinstallationinstallation-check><a href=/docs/getting-started/installation/installation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedinstallationinstallation><span>Installation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-startedinstallationinstallation-cli-tool-li><input type=checkbox id=m-docsgetting-startedinstallationinstallation-cli-tool-check>
<label for=m-docsgetting-startedinstallationinstallation-cli-tool-check><a href=/docs/getting-started/installation/installation-cli-tool/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedinstallationinstallation-cli-tool><span>Installation of CLI Tool</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscore-concept-li><input type=checkbox id=m-docscore-concept-check>
<label for=m-docscore-concept-check><a href=/docs/core-concept/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscore-concept><span>Core Concept</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscore-conceptresource-optimize-model-li><input type=checkbox id=m-docscore-conceptresource-optimize-model-check>
<label for=m-docscore-conceptresource-optimize-model-check><a href=/docs/core-concept/resource-optimize-model/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscore-conceptresource-optimize-model><span>Application Resource Optimize Model</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscore-concepttimeseries-forecasting-by-dsp-li><input type=checkbox id=m-docscore-concepttimeseries-forecasting-by-dsp-check>
<label for=m-docscore-concepttimeseries-forecasting-by-dsp-check><a href=/docs/core-concept/timeseries-forecasting-by-dsp/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscore-concepttimeseries-forecasting-by-dsp><span>Time Series Forecast Algorithm-DSP</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscore-conceptarchitecture-li><input type=checkbox id=m-docscore-conceptarchitecture-check>
<label for=m-docscore-conceptarchitecture-check><a href=/docs/core-concept/architecture/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscore-conceptarchitecture><span>Architecture</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docstutorials-li><input type=checkbox id=m-docstutorials-check>
<label for=m-docstutorials-check><a href=/docs/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstutorials><span>Tutorials</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docstutorialscolocation-with-enhanced-qos-li><input type=checkbox id=m-docstutorialscolocation-with-enhanced-qos-check>
<label for=m-docstutorialscolocation-with-enhanced-qos-check><a href=/docs/tutorials/colocation-with-enhanced-qos/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstutorialscolocation-with-enhanced-qos><span>Colocation with Enhanced QOS</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialscolocation-with-enhanced-qosusing-qos-ensurance-li><input type=checkbox id=m-docstutorialscolocation-with-enhanced-qosusing-qos-ensurance-check>
<label for=m-docstutorialscolocation-with-enhanced-qosusing-qos-ensurance-check><a href=/docs/tutorials/colocation-with-enhanced-qos/using-qos-ensurance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialscolocation-with-enhanced-qosusing-qos-ensurance><span>Colocation with Enhanced QOS</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialscolocation-with-enhanced-qosqos-interference-detection-and-active-avoidance-li><input type=checkbox id=m-docstutorialscolocation-with-enhanced-qosqos-interference-detection-and-active-avoidance-check>
<label for=m-docstutorialscolocation-with-enhanced-qosqos-interference-detection-and-active-avoidance-check><a href=/docs/tutorials/colocation-with-enhanced-qos/qos-interference-detection-and-active-avoidance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialscolocation-with-enhanced-qosqos-interference-detection-and-active-avoidance><span>Interference Detection and Active Avoidance</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialscolocation-with-enhanced-qosqos-dynamic-resource-oversold-and-limit-li><input type=checkbox id=m-docstutorialscolocation-with-enhanced-qosqos-dynamic-resource-oversold-and-limit-check>
<label for=m-docstutorialscolocation-with-enhanced-qosqos-dynamic-resource-oversold-and-limit-check><a href=/docs/tutorials/colocation-with-enhanced-qos/qos-dynamic-resource-oversold-and-limit/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialscolocation-with-enhanced-qosqos-dynamic-resource-oversold-and-limit><span>Dynamic resource oversold and limit</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialscolocation-with-enhanced-qosqos-accurately-perform-avoidance-actions-li><input type=checkbox id=m-docstutorialscolocation-with-enhanced-qosqos-accurately-perform-avoidance-actions-check>
<label for=m-docstutorialscolocation-with-enhanced-qosqos-accurately-perform-avoidance-actions-check><a href=/docs/tutorials/colocation-with-enhanced-qos/qos-accurately-perform-avoidance-actions/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialscolocation-with-enhanced-qosqos-accurately-perform-avoidance-actions><span>Accurately Perform Avoidance Actions</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialscolocation-with-enhanced-qosqos-customized-metrics-interference-detection-avoidance-and-sorting-li><input type=checkbox id=m-docstutorialscolocation-with-enhanced-qosqos-customized-metrics-interference-detection-avoidance-and-sorting-check>
<label for=m-docstutorialscolocation-with-enhanced-qosqos-customized-metrics-interference-detection-avoidance-and-sorting-check><a href=/docs/tutorials/colocation-with-enhanced-qos/qos-customized-metrics-interference-detection-avoidance-and-sorting/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialscolocation-with-enhanced-qosqos-customized-metrics-interference-detection-avoidance-and-sorting><span>Define your watermark</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialscolocation-with-enhanced-qosqos-enhanced-bypass-cpuset-management-li><input type=checkbox id=m-docstutorialscolocation-with-enhanced-qosqos-enhanced-bypass-cpuset-management-check>
<label for=m-docstutorialscolocation-with-enhanced-qosqos-enhanced-bypass-cpuset-management-check><a href=/docs/tutorials/colocation-with-enhanced-qos/qos-enhanced-bypass-cpuset-management/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialscolocation-with-enhanced-qosqos-enhanced-bypass-cpuset-management><span>Enhanced bypass cpuset management capability</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docstutorialsrecommendation-li><input type=checkbox id=m-docstutorialsrecommendation-check>
<label for=m-docstutorialsrecommendation-check><a href=/docs/tutorials/recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstutorialsrecommendation><span>Recommendation</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationrecommendation-framework-li><input type=checkbox id=m-docstutorialsrecommendationrecommendation-framework-check>
<label for=m-docstutorialsrecommendationrecommendation-framework-check><a href=/docs/tutorials/recommendation/recommendation-framework/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationrecommendation-framework><span>Recommendation Framework</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationreplicas-recommendation-li><input type=checkbox id=m-docstutorialsrecommendationreplicas-recommendation-check>
<label for=m-docstutorialsrecommendationreplicas-recommendation-check><a href=/docs/tutorials/recommendation/replicas-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationreplicas-recommendation><span>Replicas Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationresource-recommendation-li><input type=checkbox id=m-docstutorialsrecommendationresource-recommendation-check>
<label for=m-docstutorialsrecommendationresource-recommendation-check><a href=/docs/tutorials/recommendation/resource-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationresource-recommendation><span>Resource Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationidlenode-recommendation-li><input type=checkbox id=m-docstutorialsrecommendationidlenode-recommendation-check>
<label for=m-docstutorialsrecommendationidlenode-recommendation-check><a href=/docs/tutorials/recommendation/idlenode-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationidlenode-recommendation><span>IdleNode Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationhpa-recommendation-li><input type=checkbox id=m-docstutorialsrecommendationhpa-recommendation-check>
<label for=m-docstutorialsrecommendationhpa-recommendation-check><a href=/docs/tutorials/recommendation/hpa-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationhpa-recommendation><span>HPA Recommendation（Alpha）</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationservice-recommendation-li><input type=checkbox id=m-docstutorialsrecommendationservice-recommendation-check>
<label for=m-docstutorialsrecommendationservice-recommendation-check><a href=/docs/tutorials/recommendation/service-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationservice-recommendation><span>Service Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationpv-recommendation-li><input type=checkbox id=m-docstutorialsrecommendationpv-recommendation-check>
<label for=m-docstutorialsrecommendationpv-recommendation-check><a href=/docs/tutorials/recommendation/pv-recommendation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationpv-recommendation><span>PV Recommendation</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsrecommendationhow-to-develop-recommender-li><input type=checkbox id=m-docstutorialsrecommendationhow-to-develop-recommender-check>
<label for=m-docstutorialsrecommendationhow-to-develop-recommender-check><a href=/docs/tutorials/recommendation/how-to-develop-recommender/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsrecommendationhow-to-develop-recommender><span>How to develop Recommender</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsdynamic-scheduler-plugin-li><input type=checkbox id=m-docstutorialsdynamic-scheduler-plugin-check>
<label for=m-docstutorialsdynamic-scheduler-plugin-check><a href=/docs/tutorials/dynamic-scheduler-plugin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsdynamic-scheduler-plugin><span>Dynamic-scheduler: a load-aware scheduler plugin</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsscheduling-pods-based-on-actual-node-load-li><input type=checkbox id=m-docstutorialsscheduling-pods-based-on-actual-node-load-check>
<label for=m-docstutorialsscheduling-pods-based-on-actual-node-load-check><a href=/docs/tutorials/scheduling-pods-based-on-actual-node-load/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsscheduling-pods-based-on-actual-node-load><span>Crane-scheduler</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsusing-effective-hpa-to-scaling-with-effectiveness-li><input type=checkbox id=m-docstutorialsusing-effective-hpa-to-scaling-with-effectiveness-check>
<label for=m-docstutorialsusing-effective-hpa-to-scaling-with-effectiveness-check><a href=/docs/tutorials/using-effective-hpa-to-scaling-with-effectiveness/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsusing-effective-hpa-to-scaling-with-effectiveness><span>Effective HorizontalPodAutoscaler</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorialsusing-time-series-prediction-li><input type=checkbox id=m-docstutorialsusing-time-series-prediction-check>
<label for=m-docstutorialsusing-time-series-prediction-check><a href=/docs/tutorials/using-time-series-prediction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorialsusing-time-series-prediction><span>TimeSeriesPrediction</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsbest-practices-li><input type=checkbox id=m-docsbest-practices-check>
<label for=m-docsbest-practices-check><a href=/docs/best-practices/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsbest-practices><span>Best Practices</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsbest-practiceseffective-hpa-with-prometheus-adapter-li><input type=checkbox id=m-docsbest-practiceseffective-hpa-with-prometheus-adapter-check>
<label for=m-docsbest-practiceseffective-hpa-with-prometheus-adapter-check><a href=/docs/best-practices/effective-hpa-with-prometheus-adapter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsbest-practiceseffective-hpa-with-prometheus-adapter><span>Intelligent Autoscaling Practices Based on Effective HPA for Custom Metrics</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsbest-practiceshow-to-optimize-your-application-resource-li><input type=checkbox id=m-docsbest-practiceshow-to-optimize-your-application-resource-check>
<label for=m-docsbest-practiceshow-to-optimize-your-application-resource-check><a href=/docs/best-practices/how-to-optimize-your-application-resource/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsbest-practiceshow-to-optimize-your-application-resource><span>How to optimize your application in FinOps era</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsbest-practiceshow-kujiale-adopt-ehpa-li><input type=checkbox id=m-docsbest-practiceshow-kujiale-adopt-ehpa-check>
<label for=m-docsbest-practiceshow-kujiale-adopt-ehpa-check><a href=/docs/best-practices/how-kujiale-adopt-ehpa/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsbest-practiceshow-kujiale-adopt-ehpa><span>How Kujiale achieve autoscaling with Crane EHPA</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsproposals-li><input type=checkbox id=m-docsproposals-check checked>
<label for=m-docsproposals-check><a href=/docs/proposals/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsproposals><span>Proposals</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposals20220228-advanced-cpuset-manger-li><input type=checkbox id=m-docsproposals20220228-advanced-cpuset-manger-check>
<label for=m-docsproposals20220228-advanced-cpuset-manger-check><a href=/docs/proposals/20220228-advanced-cpuset-manger/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposals20220228-advanced-cpuset-manger><span>Advanced CPUSet Manager</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposals20220402-policy-based-abnomal-detection-li><input type=checkbox id=m-docsproposals20220402-policy-based-abnomal-detection-check>
<label for=m-docsproposals20220402-policy-based-abnomal-detection-check><a href=/docs/proposals/20220402-policy-based-abnomal-detection/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsproposals20220402-policy-based-abnomal-detection><span class=td-sidebar-nav-active-item>Provide a policy-based abnormal detection mechanism in crane-agent</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposals20220706-recommendation-framework-li><input type=checkbox id=m-docsproposals20220706-recommendation-framework-check>
<label for=m-docsproposals20220706-recommendation-framework-check><a href=/docs/proposals/20220706-recommendation-framework/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposals20220706-recommendation-framework><span>Recommendation Framework</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsproposalspod-sorting-and-precise-execution-for-crane-agent-li><input type=checkbox id=m-docsproposalspod-sorting-and-precise-execution-for-crane-agent-check>
<label for=m-docsproposalspod-sorting-and-precise-execution-for-crane-agent-check><a href=/docs/proposals/pod-sorting-and-precise-execution-for-crane-agent/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsproposalspod-sorting-and-precise-execution-for-crane-agent><span>Pod Sorting And Precise Execution For Crane Agent</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li><input type=checkbox id=m-docscontributing-check>
<label for=m-docscontributing-check><a href=/docs/contributing/ title=Contributing class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing Guidelines</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingcontributing-li><input type=checkbox id=m-docscontributingcontributing-check>
<label for=m-docscontributingcontributing-check><a href=/docs/contributing/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingcontributing><span>Contributing to Crane</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingdeveloper-guide-li><input type=checkbox id=m-docscontributingdeveloper-guide-check>
<label for=m-docscontributingdeveloper-guide-check><a href=/docs/contributing/developer-guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdeveloper-guide><span>Developer Guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingcode-standards-li><input type=checkbox id=m-docscontributingcode-standards-check>
<label for=m-docscontributingcode-standards-check><a href=/docs/contributing/code-standards/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingcode-standards><span>Code Standard</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsroadmap-li><input type=checkbox id=m-docsroadmap-check>
<label for=m-docsroadmap-check><a href=/docs/roadmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsroadmap><span>Roadmap</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsroadmaproadmap-2023-li><input type=checkbox id=m-docsroadmaproadmap-2023-check>
<label for=m-docsroadmaproadmap-2023-check><a href=/docs/roadmap/roadmap-2023/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsroadmaproadmap-2023><span>Roadmap for 2023</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsroadmaproadmap-2022-li><input type=checkbox id=m-docsroadmaproadmap-2022-check>
<label for=m-docsroadmaproadmap-2022-check><a href=/docs/roadmap/roadmap-2022/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsroadmaproadmap-2022><span>Roadmap for 2022</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsmirror-resources-li><input type=checkbox id=m-docsmirror-resources-check>
<label for=m-docsmirror-resources-check><a href=/docs/mirror-resources/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsmirror-resources><span>Mirror Resources</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#summary>Summary</a></li><li><a href=#motivation>Motivation</a><ul><li><a href=#goals>Goals</a></li><li><a href=#non-goals>Non-Goals</a></li></ul></li><li><a href=#proposal>Proposal</a><ul><li><a href=#user-stories>User Stories</a></li><li><a href=#functional-requirements>Functional Requirements</a></li><li><a href=#implementation-details>Implementation Details</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/proposals/>Proposals</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/proposals/20220402-policy-based-abnomal-detection/>Provide a policy-based abnormal detection mechanism in crane-agent</a></li></ol></nav><div class=td-content><h1>Provide a policy-based abnormal detection mechanism in crane-agent</h1><header class=article-meta><p class=reading-time><i class="fa fa-clock" aria-hidden=true></i>&nbsp; 5 minute read &nbsp;</p></header><h2 id=summary>Summary</h2><p>Crane-agent is responsible for detecting abnormality on nodes and interference between running pods.</p><p>Currently, such detection mechanism is fixed and quite simple.
Crane-agent compares the values of some pre-defined metrics, such as node&rsquo;s <code>cpu_total_usage</code> and <code>cpu_total_utilization</code>,
with some thresholds periodically. If the metric value is higher the threshold for some times, say the <code>cpu_total_utilization</code>
on a node is found higher than 80% in 3 consecutive detections, crane-agent thinks the node entering into an abnormal status,
and will perform some further actions, such as suppressing or evicting pods with low priorities.</p><p>This proposal suggests a flexible and extensible way to detect abnormality. The criteria of abnormality can be customized by
users in form of policies, and the detection process is executed in a policy decision-making way, which is offloaded to a
general-purpose policy engine.</p><h2 id=motivation>Motivation</h2><p>The criteria of abnormality or interference are not that always as simple as something like a metric value is higher than a threshold.
Different users may have different QOS requirements on different applications in different environments. The rule of
abnormality detection varies, and it is impossible to implement all of them in code in advance.</p><h3 id=goals>Goals</h3><ol><li>Provides an abnormality detection mechanism which can consume external metrics.</li><li>Provides an abnormality detection mechanism in which the logic determining how to check the abnormality can be customized.</li><li>Metrics and detection policies can be added, updated and deleted on the fly without changing the code.</li></ol><h3 id=non-goals>Non-Goals</h3><ol><li>How to handle the abnormality or interference. This proposal only focuses on detection, and the subsequent action is
out of scope.</li></ol><h2 id=proposal>Proposal</h2><h3 id=user-stories>User Stories</h3><h4 id=story-1>Story 1</h4><p>A user has a critical online application which is latency sensitive running in the cluster, and he wants to use both
the 99th percentile response time and the error code rate as the application QOS indicators. If either of these 2 indicators
deteriorates, the application is thought of being in abnormal status.</p><h4 id=story-2>Story 2</h4><p>The SRE team finds that if the node CPU utilization is more than 60%, the QOS of some latency sensitive applications
running on it are likely to decline. So they want to keep the node CPU utilization lower than 60%.
If the utilization is higher than this threshold, the BE applications should be suppressed
accordingly.</p><h4 id=story-3>Story 3</h4><p>The traffic of online applications is very low at night, and the offline jobs are run during this time.
Comparing with online applications, offline jobs always require more CPU resource quantities but less resource qualities.
In this case, the SRE team wants to set different node CPU load thresholds in the daytime and at night.</p><h3 id=functional-requirements>Functional Requirements</h3><h3 id=implementation-details>Implementation Details</h3><h4 id=api>API</h4><p>#####NodeQOSEnsurancePolicy</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>NodeQOSEnsurancePolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>nodeQualityProbe</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>prometheus</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9090&#39;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>queryInterval</span>: <span style=color:#ae81ff>60s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>metrics</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>node_cpu_utilization</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>query</span>: <span style=color:#ae81ff>1</span> - <span style=color:#ae81ff>avg(irate(node_cpu_seconds_total{mode=&#34;idle&#34;, instance=&#34;$nodeName&#34;}[5m]))</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nodeName</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>fieldRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>fieldPath</span>: <span style=color:#ae81ff>spec.nodeName</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>objectiveEnsurances</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;ext_cpu_total_distribute&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>avoidanceThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restoreThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>actionName</span>: <span style=color:#e6db74>&#34;disablescheduling&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>policy</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        default abnormal = false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        hour := time.clock([time.now_ns(), &#34;Local&#34;])[0]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        abnormal {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          input.node_cpu_utilization &gt; 0.6
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          hour &gt;= 7, hour &lt; 21
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        abnormal {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          input.node_cpu_utilization &gt; 0.8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          hour &gt;= 21
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        abnormal {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          input.node_cpu_utilization &gt; 0.8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          hour &lt; 7
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }</span>        
</span></span></code></pre></div><p>#####PodQOSEnsurancePolicy</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ensurance.crane.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PodQOSEnsurancePolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>qualityProbe</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>prometheus</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9090&#39;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>queryInterval</span>: <span style=color:#ae81ff>60s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>metrics</span>: 
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test_app_p90_latency</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>query</span>: <span style=color:#ae81ff>histogram_quantile(0.9, rate(http_request_duration_seconds_bucket{pod=~&#34;$podName&#34;, node=&#34;$nodeName&#34;}[1m]))</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>podName</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>fieldRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>fieldPath</span>: <span style=color:#ae81ff>metadata.name</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nodeName</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>fieldRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>fieldPath</span>: <span style=color:#ae81ff>spec.nodeName</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>objectiveEnsurances</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;ext_cpu_total_distribute&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>avoidanceThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restoreThreshold</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>actionName</span>: <span style=color:#e6db74>&#34;disablescheduling&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>policy</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span>        <span style=color:#ae81ff>abnormal if test_app_p90_latency[_].value &gt; 0.1</span>
</span></span></code></pre></div><p>In addition to <code>Prometheus</code>, other protocols, such as <code>Graphite</code>, <code>InfluxDB</code> can also
be added in the future.</p><h4 id=metrics>Metrics</h4><h4 id=built-in-metrics>Built-in metrics</h4><p>Currently, crane-agent collects a bunch of metrics(defined in <code>pkg/ensurance/collector/types/types.go</code>, e.g.
<code>cpu_total_usage</code>).
These metrics are collected by <code>nodelocal</code> and <code>cadvisor</code> collectors, both of which collects metrics every 10 seconds.</p><p>We call these metrics as built-in metrics. Users can use built-in metrics in the policy without explicit setting, and
crane-agent will pass their values to every request to policy engine.</p><h5 id=external-metrics-new>External metrics (New)</h5><p>Crane-agent can also get <code>external</code> metrics by querying against prometheus servers. A new <code>prometheus</code> quality probe
will be added to CRDs <code>PodQOSEnsurancePolicy</code> and <code>NodeQOSEnsurancePolicy</code> as shown in above 2 example yamls.</p><p>In <a href=#PodQOSEnsurancePolicy>PodQOSEnsurancePolicy</a>, <code>.spec.nodeQualityProbe.prometheus.metrics.query</code> is a promQL, which
may includes some node variables (prefixed with <code>$</code>). In this case, crane-agent will use its node name
to replace the variable <code>$nodeName</code>.</p><p>In <a href=#PodQOSEnsurancePolicy>PodQOSEnsurancePolicy</a>, <code>.spec.qualityProbe.prometheus.metrics.query</code> is a promQL, which
may includes some pod related variables (<code>$nodeName</code>, <code>$podName</code> in this example). Crane-agent will firstly
get all pods that match the <code>.spec.selector.matchLabels</code> on its node. Say two pods are selected, and
their names are <code>pod-1</code> and <code>pod-2</code>, and the node name is <code>node-1</code>. The replaced promQL will be</p><pre tabindex=0><code>histogram_quantile(0.9, rate(http_request_duration_seconds_bucket{pod=~&#34;pod-1|pod-2&#34;, node=&#34;node-1&#34;}[1m]))
</code></pre><p>And 2 query results are expected to get returned, like:</p><pre tabindex=0><code>test_app_p90_latency{pod=&#34;pod-1&#34;, ...} 0.01
test_app_p90_latency{pod=&#34;pod-2&#34;, ...} 0.01
</code></pre><p>Simply speaking, variables in promQL help crane-agent only query metrics of its own node and the pods that running on its own node.</p><h4 id=embedded-metrics-tsdb>Embedded metrics TSDB</h4><p>In order to decouple the components that collect metrics and those which consume the metrics, and to
make these components&rsquo; logic simple, an embedded metrics TSDB will be imported into crane-agent.</p><p>Prometheus-tsdb and vmstorage are two good candidates, both of which are easy to insert values and are
compatible with promQL query grammar.</p><p>Both analyzer and executor fetch metrics from the TSDB without considering where the metrics come from.</p><p><img src=/images/tsdb.png alt></p><h4 id=policy>Policy</h4><p>The Open Policy Agent (OPA) is an open source, general-purpose policy engine that unifies policy enforcement.
Crane-agent will use it to evaluate if nodes or pods are abnormal.</p><p>The criteria for detecting abnormality is not pre-defined or hardcoded, instead, it is customized by users
at runtime.</p><p>A <code>policy</code> filed will be added to <code>ObjectiveEnsurance</code>, which is
a <a href=https://www.openpolicyagent.org/docs/latest/policy-language/>rego</a> rule whose result is a boolean
element.</p><p>crane-agent will feed both the latest built-in and external metrics as input into the OPA policy engine, and OPA
make decisions based on input and policies.</p><p><img src=/images/opa.png alt></p><p>A sample input is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;crane&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cpu_total_usage&#34;</span>: <span style=color:#ae81ff>4680</span>,
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>...</span> <span style=color:#960050;background-color:#1e0010>orhter</span> <span style=color:#960050;background-color:#1e0010>built-in</span> <span style=color:#960050;background-color:#1e0010>mertrcs</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;test_app_p90_latency&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;labels&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;pod&#34;</span>: <span style=color:#e6db74>&#34;pod-1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;node&#34;</span>: <span style=color:#e6db74>&#34;node-1&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;labels&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;pod&#34;</span>: <span style=color:#e6db74>&#34;pod-2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;node&#34;</span>: <span style=color:#e6db74>&#34;node-1&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>0.09</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></main></div></div></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.aa9f4c5dae6a98b2c46277f4c56f1673a2b000d1756ce4ffae93784cab25e6d5.js integrity="sha256-qp9MXa5qmLLEYnf0xW8Wc6KwANF1bOT/rpN4TKsl5tU=" crossorigin=anonymous></script></body></html>